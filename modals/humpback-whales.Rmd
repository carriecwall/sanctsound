---
output: html_document
editor_options: 
  chunk_output_type: console
---
```{r, include=F}
knitr::opts_chunk$set(echo=F, message=F, warning=F, error=F)
```

```{r}
library(readr)
library(knitr)
library(here)
library(glue)
library(fs)
library(dplyr)
library(stringr)
library(purrr)
source(here("functions.R"))

#width_in = 3
modals_csv <- "https://docs.google.com/spreadsheets/d/1zmbqDv9KjWLYD9fasDHtPXpRh5ScJibsCHn56DYhTd0/gviz/tq?tqx=out:csv&sheet=modals"

modals <- read_csv(modals_csv)

imgs <- modals %>% 
  filter(path_ext(filename) != "wav") %>% 
  mutate(
    gdrive_id = str_replace(
      gdrive_shareable_link, 
      "https://drive.google.com/file/d/(.*)/view\\?usp=sharing", 
      "\\1"),
    gdrive_dl = glue("https://drive.google.com/uc?id={gdrive_id}&export=download"),
    path_0    = here(glue("images/{filename}")),
    path_w    = glue("{path_ext_remove(path_0)}_w{image_width_inches}in.{path_ext(path_0)}"),
    path_r    = glue("../images/{basename(path_w)}"))

wavs <- modals %>% 
  filter(path_ext(filename) == "wav")

# download images
imgs %>% 
  filter(!file_exists(path_0)) %>% 
  select(gdrive_dl, path_0) %>% 
  pwalk(~download.file(.x, .y))

# resize images to specified width
imgs %>% 
  filter(!file_exists(path_w)) %>% 
  select(path_0, path_w, image_width_inches) %>% 
  pwalk(~img_convert(..1, ..2, width_in = ..3))

current_rmd <- current_input()
```

## {.tabset}

### Sights & Sounds

<div class="row">
<div class="col-xs-6">
```{r, results = "asis"}
img <- imgs %>% 
  filter(
    modal_rmd == current_rmd,
    tab == "Sights & Sounds")
glue("![{img$caption}]({img$path_r})")
```
</div>
<div class="col-xs-6">
```{r}
# mp4 <- here::here("data/wav/SanctSound_HI03_01_HWsong_20190130T144409Z_3s.mp4")
# htmltools::tags$video(id=basename(mp4), type = "video/mp4",src = mp4, controls = "controls")
vembedr::embed_url("https://youtu.be/AHnpFwunPKA")
```
</div>
</div>

### Patterns, daily

```{r, results = "asis"}
img <- imgs %>% 
  filter(
    modal_rmd == current_rmd,
    tab == "Patterns, daily")
glue("![{img$caption}]({img$path_r})")
```

### Patterns, hourly

```{r, results = "asis"}
img <- imgs %>% 
  filter(
    modal_rmd == current_rmd,
    tab == "Patterns, hourly")
glue("![{img$caption}]({img$path_r})")
```
