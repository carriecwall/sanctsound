---
output: html_document
editor_options: 
  chunk_output_type: console
---
```{r, include=F}
knitr::opts_chunk$set(echo=F, message=F, warning=F, error=F)
```

```{r}
library(readr)
library(knitr)
library(here)
library(glue)
library(fs)
library(dplyr)
library(stringr)
library(purrr)
source(here("functions.R"))

modals_csv <- "https://docs.google.com/spreadsheets/d/1zmbqDv9KjWLYD9fasDHtPXpRh5ScJibsCHn56DYhTd0/gviz/tq?tqx=out:csv&sheet=modals"

exts <- list(
  imgs = c("png","jpg","jpeg"),
  snds = c("wav"))

modals <- read_csv(modals_csv)

imgs <- modals %>% 
  filter(tolower(path_ext(filename)) %in% exts$imgs) %>% 
  mutate(
    gdrive_id = str_replace(
      gdrive_shareable_link, 
      "https://drive.google.com/file/d/(.*)/view\\?usp=sharing", 
      "\\1"),
    gdrive_dl = glue("https://drive.google.com/uc?id={gdrive_id}&export=download"),
    path_0    = here(glue("images/{filename}")),
    path_w    = glue("{path_ext_remove(path_0)}_w{image_width_inches}in.{path_ext(path_0)}"),
    path_r    = glue("../images/{basename(path_w)}"))

snds <- modals %>% 
  filter(tolower(path_ext(filename)) %in% exts$snds) %>% 
  mutate(
    gdrive_id = str_replace(
      gdrive_shareable_link, 
      "https://drive.google.com/file/d/(.*)/view\\?usp=sharing", 
      "\\1"),
    gdrive_dl = glue("https://drive.google.com/uc?id={gdrive_id}&export=download"),
    path_0    = here(glue("sounds/{filename}")),
    path_m    = glue("{path_ext_remove(path_0)}.mp4"),
    path_r    = glue("../sounds/{basename(path_m)}"))

# download images
imgs %>% 
  filter(!file_exists(path_0) | redo) %>% 
  select(gdrive_dl, path_0) %>% 
  pwalk(~download.file(.x, .y))

# resize images to specified width
imgs %>% 
  filter(!file_exists(path_w) | redo) %>% 
  select(path_0, path_w, image_width_inches) %>% 
  pwalk(~img_convert(..1, ..2, width_in = ..3))

# download sounds
snds %>% 
  filter(!file_exists(path_0) | redo) %>% 
  select(gdrive_dl, path_0) %>% 
  pwalk(~download.file(.x, .y))


library(fs)
library(av)
library(tibble)
library(dplyr)
library(purrr)

dir_wav <- "/Volumes/GoogleDrive/.shortcut-targets-by-id/1fyEXTbnbTjqgxvYHg3lXnr3JQzwxJa1y/SoundClips/Exemplar"
snds <- tibble(
  path_wav = dir_ls(dir_wav, glob = "*.wav")) %>% 
  mutate(
    path_mp3 = path_ext_set(path_wav, "mp3"),
    av_info  = map(path_wav, av_media_info))

# ,
#     av_info  = map(path_mp3, av_media_info),
#     )
  
# av_media_info(snds$path_wav[1])
# av_media_info(snds$path_wav[1])
    #   (dir_wav, glob = "*.wav"),
    # av_audio_convert()
    

# info()
# 
#   list.files(, "wav$")

imgs <- modals %>% 
  filter(tolower(path_ext(filename)) %in% exts$imgs) %>% 
  mutate(
    gdrive_id = str_replace(
      gdrive_shareable_link, 
      "https://drive.google.com/file/d/(.*)/view\\?usp=sharing", 
      "\\1"),
    gdrive_dl = glue("https://drive.google.com/uc?id={gdrive_id}&export=download"),
    path_0    = here(glue("images/{filename}")),
    path_w    = glue("{path_ext_remove(path_0)}_w{image_width_inches}in.{path_ext(path_0)}"),
    path_r    = glue("../images/{basename(path_w)}"))

# snds %>% 
#   filter(!file_exists(path_0) | redo) %>% 
#   select(gdrive_dl, path_0) %>% 
#   pwalk(~download.file(.x, .y))


# convert to movie if not found
# snd1 <- snds %>% 
# #snds %>% 
#   filter(!file_exists(path_m) | redo) %>% 
#   select(path_0, path_m) %>% 
#   head(1)
#   pull(path_0)
#   pwalk(
#     ~av_spectrogram_video(
#       ..1, output = ..2, 
#       width = 1280, height = 720, res = 144))
  
# wav <- snd1$path_0
# mp3 <- path_ext_set(wav, "mp3")
# mov <- snd1$path_m
# 
# av_audio_convert(wav, mp3) # , total_time = 3)

# Specified sample rate 2000 is not supported
# Error: FFMPEG error in 'avcodec_open2 (audio)': Invalid argument

# snd_convert <- function()
# 
# #library(htmltools)
# library(av)  # install.packages("av")
# 
# 
# for (wav in wavs){
#   mp3 <- glue("{path_ext_remove(wav)}_3s.mp4")
#   mp4 <- glue("{path_ext_remove(wav)}_3s.mp4")
#   
#   #if (!file.exists(mp4)){
#   if (F){
#     av_audio_convert(wav, mp3, total_time = 3)
#     
#   }
# }

# mp4 <- file.path("data/wav", basename(path_ext_set(wav, "mp4")))
# tags$video(id=basename(mp4), type = "video/mp4",src = mp4, controls = "controls")

current_rmd <- current_input()
message(glue("current_rmd: {current_rmd}"))
```

## {.tabset}

### Sights & Sounds

<div class="row">
<div class="col-xs-6">
```{r, results = "asis"}
img <- imgs %>% 
  filter(
    modal_rmd == current_rmd,
    tab == "Sights & Sounds")
glue("![{img$caption}]({img$path_r})")
```
</div>
<div class="col-xs-6">
```{r}
# mp4 <- here::here("data/wav/SanctSound_HI03_01_HWsong_20190130T144409Z_3s.mp4")
# htmltools::tags$video(id=basename(mp4), type = "video/mp4",src = mp4, controls = "controls")
vembedr::embed_url("https://youtu.be/AHnpFwunPKA")
```
</div>
</div>

### Patterns, daily

```{r, results = "asis"}
img <- imgs %>% 
  filter(
    modal_rmd == current_rmd,
    tab == "Patterns, daily")
glue("![{img$caption}]({img$path_r})")
```

### Patterns, hourly

```{r, results = "asis"}
img <- imgs %>% 
  filter(
    modal_rmd == current_rmd,
    tab == "Patterns, hourly")
glue("![{img$caption}]({img$path_r})")
```
